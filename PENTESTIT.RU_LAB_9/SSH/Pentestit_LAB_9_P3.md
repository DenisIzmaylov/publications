## Получение флага SSH - корпоративная лаборатория Pentestit.ru v9

Теперь настало время для продвижения далее. Через найденный в прошлых частях уязвимости мы только лишь получали данные и не получили доступ внутрь сети организации. Настало время попробовать на прочность 22 порт ssh, который открыт. Для этого нам необходимо просто попробовать законнектиться без указания пользователя, пусть будет текущий root. Выполняем команду ssh 192.168.101.8 и видим следующу картину:

![VirtualBox_Kali2016.2_18_09_2016_21_10_16](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_21_10_16.png)

Видим интересный баннер с кинформацией что используется пам модуль для авторизации. Кстати многие пишут такие модули для того чтобы упростить доступ для людей из вне и при этом как бы ограничить какими бы то нибыло условиями время пребывания человека в сети. К примеру могут ограничить срок действия некого простого пароля, который генерируется на основании каких либо факторов.

Пароль естественно мы не знаем и тут как говорится, нужно искать, получать информацию, которая бы могла пролить свет на кастомный механизм PAM модуля для SSH. 

В первую очередь бросается в глаза `(c) krakenwaffe` , похоже что автор оставил копирайт. Это очень интересно. В дело подключается фаза сбора информации - `recon` как говорится. Предполагаем что раз это разработчик модуля то можно попробовать поискать информацию о нем на github.com. 

В этом поможет утилитка gitrob, при помощи которой можно искать сенситив информацию на GitHub, в ней есть много паттернов по которым она может маркировать файлы для того чтобы обратить на них внимание.

![VirtualBox_Kali2016.2_18_09_2016_21_20_24](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_21_20_24.png)

Скармливаем программе команду gitrob analyze krakenwaffe и ждем что же она нам отыщет. А отсыскала она репозиторий принадлежащий пользователю по этим ником. 

![VirtualBox_Kali2016.2_18_09_2016_21_23_16](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_21_23_16.png)

Смотрим что же интересного можно почерпнуть из найденных исходных файлов.

![VirtualBox_Kali2016.2_18_09_2016_21_24_10](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_21_24_10.png)

Видим что присутсвует какой то `mypam.c` и из названия понимаем, что возможно это то что мы ищим. Начинаем с анализа исходного кода. 

![VirtualBox_Kali2016.2_18_09_2016_21_24_44](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_21_24_44.png)

Видим что этот пам модуль опирается на учетные записи насположенные в `/etc/passwd`, а также обращаем внимание на то, что запрещен вход под `root` ом. 

![VirtualBox_Kali2016.2_18_09_2016_21_26_02](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_21_26_02.png)

Также видим, что в случае срабатывания PAM модуля, нам будет выдано приглашение ввести пароль `"The password: "` - как видите это необычно. Такого приглашения мы не видели когда коннектились под рутом к ssh cybear32c организации, что подтверждает блокировку входа по рутом.

Видим что в качестве пароля используется фраза `daypass` + `число текущего дня в месяце` + `число текущего часа`. В итоге у нас должно получиться что то типа `daypassDDHH`. Стоит заметить что тут важен момент того что если текщее число дня в месяце < 10 то ноль перед числом не ставится так как это целое число а не строка как мы привыкли указывать в дате. 

Но тут встает проблема, так как у нас множество временных зон и нужно как то подобрать значение часа. Но это не проблема, я выбрал следующую стратегию: взять текущее число и текущее значение часа, отнимать по одному часу назад и пробовать входить. Таким образом если текущие сутки в тайм зоне на сервере не отличаются от моих, то число попыток будет равно 24 или того меньше.

Но есть еще проблема - мы не знаем по каким пользователем собственно входить то! root заблокирован, а как же нам найти список пользователей или получить дополниельную информацию. Вот тут конечно мы можем взять инициалы пользователя и github и как то с ними поиграться, нащупывая паттерн по которому формируются корпоративные логины, но я выбрал другой путь. Посмотрев в код PAM модуля стало ясно что он использует список `/etc/passwd` , а это значит, что любой стандартный пользователь, который присутсвует в этом файле сможет войти в систему через PAM, но не сможет ничего сделать в ней так как прав естественно не будет нужных, но нам для начала этого и не надо. Нам нужна разведка. 

Пробуем залогиниться взяв к примеру учетку `backup`  - она должна присутствовать в системе.

![VirtualBox_Kali2016.2_18_09_2016_22_05_02](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_22_05_02.png)

Так и есть логинимся используя команду ssh backup@192.168.101.8, вводим пароль дня и вуаля! Мы в системе. Теперь самое дело осмотреться и определить какие пользователи приуствуют в системе. Смотрим в папку /home и видим три пользователя `d.hash`, `e.grant`, `t.alvarez`. Таким образом у нас есть три учетки ползователей. Но мы возьмем конечно же учетку `d.hash`, так как это автор PAM модуля и его учетка, думаю будет очень интересна. 

![VirtualBox_Kali2016.2_18_09_2016_22_06_29](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_22_06_29.png)

Как видите под учеткой backup нам ничего не доступно. Просмореть содержимое папок для трех пользователей не можем. Не беда - логинимся под d.hash - ssh d.nash@192.168.101.8 и после ввода пароля дня успешно входим в учетку.

![VirtualBox_Kali2016.2_18_09_2016_22_11_33](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_22_11_33.png)

сразу же осматриваемся, выполняем команду ls - пусто! Тогда выполняем комаду ls -al и видим скрытые папки. Нас естественно интересует папка .ssh, переходим внутрь папки.

![VirtualBox_Kali2016.2_18_09_2016_22_12_14](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/SSH/imgs/VirtualBox_Kali2016.2_18_09_2016_22_12_14.png)

И видим файл `token.txt` и это конечно не может ни радовать! Бежим фиксировать наш успех в профиле. Также тут есть ssh файлы пользователя, но для доступа во внутреннюю сеть они нам не помошники, так как используется PAM модуль. Теперь у нас есть доступ во внутреннюю сеть и это означает что мы идем в правильном направленни!.
