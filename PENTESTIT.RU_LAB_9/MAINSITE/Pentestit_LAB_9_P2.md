## Получение флага MAINSITE в лаборатории от Pentestit.ru LAB v.9

При получении предыдущего флага, был получен дамп старых паролей и определно что сайт на Wordpress и у нас есть информация о том что есть некий сквид прокси на порту 3128. Делаем вывод что пароли могут подойти к прокси хотя это и старый бэкеп. Для того чтобы проверить это утверждение, нужно установить в браузере прокси и ввести один из логинов с паролем. Если получится войти то можно произвести дальнейшие исследования.

Для начала нам нужно получить пароли из их хешей и тут нам конечно поможет john. Копируем полученные 4 хеша за исключением флага в отдельный файл и запускаем команду `john hashes.txt` . John сам определяет тип хеша и за пару секунд (да да, я не опечатался, 2 секунды если не меньше) получены все 4 пароля.

![VirtualBox_Kali2016.2_14_09_2016_22_52_35](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_14_09_2016_22_52_35.png)

Теперь у нас есть пароли и мы можем продолжить! Возьмем первый попавшийся пароль и логин к нему и попробуем подконнектиться к прокси.

![VirtualBox_Kali2016.2_14_09_2016_23_04_08](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_14_09_2016_23_04_08.png)

Указываем в качестве ip proxy адрес 192.168.101.8 и порт 3128. Затем переходим по адресу http://cybear32c.lab и видим всплывающее окно для ввода логина и пароля. Вводим первый из списка логин и пароль. Надеемся на чудо что он еще валиден и о да! 

![VirtualBox_Kali2016.2_14_09_2016_23_05_02](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_14_09_2016_23_05_02.png)

Видим что сайт также отобразился, но теперь мы уже получаем доступ к сайту через прокси. Но теперь в голове крутится мысль, а будет ли препятствовать нам WAF, если мы ходим через прокси? Чтобы ответить на это вопрос  перейдем по ссылке PoC для подтверждения SQLi уязвимости 

`http://cybear32c.lab/wp-content/plugins/wp-symposium/get_album_item.php?size=version%28%29%20;%20--` 

И вот что мы видим! WAF молчит! Хм значит для запросов через прокси WAF не работает. Отлично! Теперь нужно воспользоваться уязвимостью для получения данных. Но сначала нужно понять какой результат получается у нас в браузере.

![VirtualBox_Kali2016.2_14_09_2016_23_07_51](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_14_09_2016_23_07_51.png)

На странице виден текст ошибки и что самое интересное, мы видим что перед нами контент картики и никакого текста, выглядит странно и не понятно. Но для того чтобы понять работает ли sqli нужно воспользоваться BurpSuite, который поможет увидеть реальную картину. 

Нам необходимо настроить BurpSuite чтобы он пошел через сквид прокси cybear32c, а браузер пошел через `BurpProxy`.

![VirtualBox_Kali2016.2_15_09_2016_20_44_53](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_15_09_2016_20_44_53.png)

Нужно зайти на вкладку User options и добавить запись в Upstream Proxy Servers заполнить все как указано на скриншоте. Далее установить настроки BurpSuit прокси в браузере.

![VirtualBox_Kali2016.2_15_09_2016_20_49_01](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_15_09_2016_20_49_01.png)

После этого пытаемся загрузить сайт http://cybear32c.lab и видим что он нормально загружается. Убеждаемся что запросы идут именно через BurpSuite прокси. 

![VirtualBox_Kali2016.2_15_09_2016_20_51_19](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_15_09_2016_20_51_19.png)

На вкладке `Proxy -> HTTP Proxy` видим залогированные запросы браузера по подгрузке HTML, скриптов, стилей интересующего нас сайта. Произведем запрос с SQLi и включим перехват запросов и ответов с cybeae32c.lab. Пропускаем GET запрос, нажав кнопку Forward и получаем переваченный ответ!

![VirtualBox_Kali2016.2_15_09_2016_21_01_51](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali2016.2_15_09_2016_21_01_51.png)

И видим в теле ответа версию MySQL базы данных cybear32c.lab. Значит PoC рабочий и мы можем дальше развивать успех в этом направлении. Но почему в браузере мы не видели этого текста? Ответ очень прост и виден в заголовках ответа `Content-Type: image/jpeg` , по этой причине браузер отображает нам темно-серую картинку с текстом ошибки поверх. 

Нам необходимо понять какая структура запроса и что мы можем заинжектить. Для этого я начал пробовать различные начинки (я не буду приводить все попытки, лиш укажу те что оказались результирующими). Самое первое ограничение, которое не давало так просто развернуться - это конечно размер данных возвращаемых в ответе, по этой причине пришлось использовать ограничение вывода. Но главное, как я понял что и как инжектить через уязвимый параметр - это прежде всего чтение опубликовынных различными исследователями статей и в частности одна из них мне больше всего понравилась, так как автор подошел очень скрупулезно и описал большое кол-во разных sqli в различном функционале вордпресса. Вот ссылка на эту статью http://ceriksen.com/2013/02/18/wp-symposium-multiple-sql-injection/ . 

![WP_Symposium_multiple_SQL_injection_vulnerabilities](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/WP_Symposium_multiple_SQL_injection_vulnerabilities.png)

Из исходного кода модулей понятно что наш SQLi пейлоад инжектится через параметр `$size` в запросе 

`"SELECT ".$size." FROM ".$wpdb->base_prefix."symposium_gallery_items WHERE iid = %d";`

Таким образом нам ничего не мешает и мы фактически экномомим на слове SELECT и нам нужно составить запрос, который может содержать сразу нужные колонки затем стандартный FROM и если надо WHERE, а остальную часть запроса просто комментируем при помощи `--+` . Таким образом часть запроса `" FROM ".$wpdb->base_prefix."symposium_gallery_items WHERE iid = %d"` комментируется и не участвует в запросах.

Далее я попробовал получить список таблиц из `information_schema.tables` ведь среди списка таблиц, можно будет найти что-то полезное. Из таблицы `wp_users` ничего интересного не было, там был хеш пользователя `adm`, а доступ к `wp_login` был запрещен что через прокси, что из вне.

![VirtualBox_Kali 2016.1_28_05_2016_22_34_01](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali 2016.1_28_05_2016_22_34_01.png)

На скриншоте выше видно, что вывод ограничивается и я не могу увидеть всю картину. С испольозванием `offset` и `limit`  можно получать данные порционно.

![VirtualBox_Kali 2016.1_28_05_2016_22_40_49](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali 2016.1_28_05_2016_22_40_49.png)

И вот наконец-то мы видим заветную таблицу под назанием `wp_token`, сразу же приходит мысль что можно произвести запрос из таблицы `wp_login` и полю `flag`, но не тут то было, в общем не все так просто и пришлось перейти к получению списка столбцов таблицы.

![VirtualBox_Kali 2016.1_28_05_2016_23_02_35](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali 2016.1_28_05_2016_23_02_35.png)

В таблице information_schema.columns конечно же сталолбцов много больше 790, но это меня не остановило. И после десятка запросов в ответе от сервера пришел список столбцов заветной таблицы. И тут организаторы подошли оригинально и назвали поле с флагом `tl9`. Ну что ж теперь остается выяснить что же находится в этом поле.

![VirtualBox_Kali 2016.1_28_05_2016_23_04_03](https://github.com/CyberLight/writeups/blob/master/PENTESTIT.RU_LAB_9/MAINSITE/imgs/VirtualBox_Kali 2016.1_28_05_2016_23_04_03.png)

И так мы получаем еще один флаг MAINSITE и конено же нужно не забыть закрепить его получени в своем профиле. Таким образом у нас есть пароли от прокси, на сайте более ничего интересного нет, так что теперь можно приступить к другим обнаруженным точкам. 